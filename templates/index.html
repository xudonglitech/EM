<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipment Management</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
        }
        header {
            background-color: #0078d4;
            color: white;
            padding: 1rem 0;
            text-align: center;
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #0078d4;
            color: white;
            cursor: pointer;
            position: relative;
        }
        th::after {
            content: '\25BC'; /* Downward triangle */
            position: absolute;
            right: 10px;
            font-size: 0.8rem;
            color: white;
        }
        .add-equipment {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
        }
        .add-equipment input {
            padding: 0.5rem;
            flex: 1;
        }
        .add-equipment button {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 4px;
        }
        .add-equipment button:hover {
            background-color: #005bb5;
        }
        select {
            padding: 0.3rem;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        select.good {
            background-color: #d4edda;
            color: #155724;
        }
        select.malfunction {
            background-color: #f8d7da;
            color: #721c24;
        }
        select.withdraw {
            background-color: #e2e3e5;
            color: #6c757d;
        }
        .editable {
            border: 1px dashed #ccc;
            padding: 4px;
            background-color: #fff;
        }
        .qrcode {
            width: 100px;
            height: 100px;
        }
        .hidden {
            display: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <header>
        <h1>Equipment Management</h1>
    </header>
    <div class="container">
        <table id="equipmentTable">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">Equipment ID</th>
                    <th onclick="sortTable(1)">Project Number</th>
                    <th onclick="sortTable(2)">Last Maintenance Date</th>
                    <th onclick="sortTable(3)">Max Flow</th>
                    <th onclick="sortTable(4)">Comments</th>
                    <th>Action</th>
                    <th class="qrcode-header hidden">QR Code</th>
                    <th>Save</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                <!-- Equipment items will be dynamically added here -->
            </tbody>
        </table>
        <div class="add-equipment">
            <input type="text" id="equipmentID" placeholder="Equipment ID">
            <input type="text" id="projectNumber" placeholder="Project Number (Optional)">
            <input type="date" id="lastMaintenance" placeholder="Enter last maintenance date here">
            <input type="text" id="maxFlow" placeholder="Max Flow">
            <input type="text" id="comments" placeholder="Comments">
            <button onclick="addEquipment()">Add Equipment</button>
            <button onclick="toggleQRCode()">Toggle QR Code Column</button>
        </div>
    </div>

<script>
    async function addEquipment() {
        const equipmentID = document.getElementById('equipmentID').value;
        const projectNumber = document.getElementById('projectNumber').value || null;
        const lastMaintenance = document.getElementById('lastMaintenance').value;
        const maxFlow = document.getElementById('maxFlow').value;
        const comments = document.getElementById('comments').value;

        if (!equipmentID || !lastMaintenance || !maxFlow || !comments) {
            alert('Please fill in all mandatory fields.');
            return;
        }

        // Check for duplicate Equipment ID
        const response = await fetch('/get_equipment');
        const equipmentList = await response.json();
        const duplicate = equipmentList.find(eq => eq.equipmentID === equipmentID);

        if (duplicate) {
            alert(`Equipment ID "${equipmentID}" already exists. Please use a unique ID.`);
            return;
        }

        const action = "good"; // Default action value
        const addResponse = await fetch('/add_equipment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ equipmentID, projectNumber, lastMaintenance, maxFlow, comments, action })
        });

        if (addResponse.ok) {
            alert('Equipment added successfully');
            location.reload();
        } else {
            alert('Failed to add equipment');
        }
    }

    async function fetchEquipment() {
        const response = await fetch('/get_equipment');
        const equipmentList = await response.json();
        const tbody = document.querySelector('#equipmentTable tbody');
        tbody.innerHTML = '';

        equipmentList.forEach(eq => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><span contenteditable="true" class="editable">${eq.equipmentID}</span></td>
                <td><span contenteditable="true" class="editable">${eq.projectNumber || ''}</span></td>
                <td><span contenteditable="true" class="editable">${eq.lastMaintenance}</span></td>
                <td><span contenteditable="true" class="editable">${eq.maxFlow}</span></td>
                <td><span contenteditable="true" class="editable">${eq.comments}</span></td>
                <td>
                    <select class="${eq.action}" onchange="updateSelectColor(this)">
                        <option value="good" ${eq.action === 'good' ? 'selected' : ''}>Good Condition</option>
                        <option value="malfunction" ${eq.action === 'malfunction' ? 'selected' : ''}>Malfunction</option>
                        <option value="withdraw" ${eq.action === 'withdraw' ? 'selected' : ''}>Withdraw</option>
                    </select>
                </td>
                <td class="qrcode hidden"><div id="qrcode-${eq.equipmentID}"></div></td>
                <td><button onclick="saveEquipment('${eq.equipmentID}')">Save</button></td>
                <td><button onclick="deleteEquipment('${eq.equipmentID}')">Delete</button></td>`;

            // Bind color-coding to the dropdown
            const select = row.querySelector('select');
            updateSelectColor(select);

            // Generate QR Code
            const qrCodeDiv = document.getElementById(`qrcode-${eq.equipmentID}`);
            new QRCode(qrCodeDiv, {
                text: `${window.location.origin}/equipment/${eq.equipmentID}`,
                width: 100,
                height: 100
            });
        });
    }

    function updateSelectColor(selectElement) {
        const classList = selectElement.classList;
        classList.remove('good', 'malfunction', 'withdraw');
        classList.add(selectElement.value);
    }

    function sortTable(columnIndex) {
        const table = document.getElementById("equipmentTable");
        const rows = Array.from(table.rows).slice(1); // Exclude header row
        const isAscending = table.getAttribute("data-sort-order") !== "asc";

        rows.sort((a, b) => {
            const aText = a.cells[columnIndex].innerText.trim();
            const bText = b.cells[columnIndex].innerText.trim();

            // Compare as numbers if both values are numeric
            if (!isNaN(aText) && !isNaN(bText)) {
                return isAscending ? aText - bText : bText - aText;
            }

            // Otherwise, compare as strings
            return isAscending ? aText.localeCompare(bText) : bText.localeCompare(aText);
        });

        rows.forEach(row => table.tBodies[0].appendChild(row)); // Re-append sorted rows
        table.setAttribute("data-sort-order", isAscending ? "asc" : "desc");
    }

    function toggleQRCode() {
        const qrCodeHeader = document.querySelector('.qrcode-header');
        const qrCodeCells = document.querySelectorAll('.qrcode');

        const isHidden = qrCodeHeader.classList.contains('hidden');

        if (isHidden) {
            qrCodeHeader.classList.remove('hidden');
            qrCodeCells.forEach(cell => cell.classList.remove('hidden'));
        } else {
            qrCodeHeader.classList.add('hidden');
            qrCodeCells.forEach(cell => cell.classList.add('hidden'));
        }
    }

    async function saveEquipment(equipmentID) {
        const row = [...document.querySelectorAll('#equipmentTable tbody tr')].find(row => row.children[0].innerText === equipmentID);
        const updatedEquipment = {
            equipmentID,
            projectNumber: row.children[1].innerText,
            lastMaintenance: row.children[2].innerText,
            maxFlow: row.children[3].innerText,
            comments: row.children[4].innerText,
            action: row.children[5].querySelector('select').value
        };

        const response = await fetch('/update_equipment', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedEquipment)
        });

        if (response.ok) {
            alert('Changes saved successfully');
        } else {
            alert('Failed to save changes');
        }
    }

    async function deleteEquipment(equipmentID) {
        const response = await fetch(`/delete_equipment/${equipmentID}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            alert('Equipment deleted successfully');
            location.reload();
        } else {
            alert('Failed to delete equipment');
        }
    }

    window.onload = fetchEquipment;
</script>
</body>
</html>
